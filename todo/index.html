<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My To-Do List</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .text-glow { text-shadow: 0 0 8px currentColor, 0 0 12px rgba(255, 255, 255, 0.3); }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(8, 217, 214, 0.4); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(8, 217, 214, 0.6); }
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .item-enter-animate { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-900 text-slate-200">

<div id="loading-overlay" class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center transition-opacity duration-500">
    <svg class="animate-spin h-8 w-8 text-cyan-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-cyan-400/80 mt-4 text-lg">Connecting to database...</p>
</div>

<div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-[#0c0a1f] via-[#05070d] to-[#12051a] -z-10"></div>

<div class="container mx-auto max-w-2xl p-4 md:p-8">
    <header class="text-center my-8">
        <h1 class="text-5xl font-bold text-white text-glow" style="color: #08d9d6;">Our ToDo List</h1>
        <p class="text-cyan-400/80 mt-2">All tasks, synced in real-time.</p>
    </header>

    <div id="add-task-card" class="bg-black/50 backdrop-blur-lg border border-cyan-500/30 rounded-xl p-6 mb-8 shadow-2xl">
        <form id="task-form" class="space-y-4">
            <input type="text" id="task-text" placeholder="e.g., Finalize quarterly report" class="w-full bg-slate-800/70 border border-slate-700 rounded-md p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 focus:outline-none transition">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="date" id="task-date" class="w-full bg-slate-800/70 border border-slate-700 rounded-md p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 focus:outline-none transition">
                <input type="time" id="task-time" class="w-full bg-slate-800/70 border border-slate-700 rounded-md p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 focus:outline-none transition">
            </div>
            <button type="submit" class="w-full flex items-center justify-center gap-2 bg-cyan-500 text-black font-bold py-3 px-4 rounded-md hover:bg-cyan-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-cyan-400 transition-all duration-200 transform hover:scale-105">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                <span>Add Task</span>
            </button>
        </form>
    </div>

    <div id="task-list-container" class="space-y-4"></div>
</div>

<div id="edit-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div id="edit-modal-content" class="item-enter-animate w-full max-w-lg bg-gray-900/70 backdrop-blur-xl border border-cyan-500/40 rounded-2xl shadow-2xl">
        <div class="p-6">
            <h2 class="text-2xl font-bold text-white mb-4">Edit Task</h2>
            <div class="space-y-4">
                <input type="text" id="edit-text" class="w-full bg-slate-800/70 border border-slate-700 rounded-md p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 focus:outline-none transition">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="date" id="edit-date" class="w-full bg-slate-800/70 border border-slate-700 rounded-md p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 focus:outline-none transition">
                    <input type="time" id="edit-time" class="w-full bg-slate-800/70 border border-slate-700 rounded-md p-3 focus:ring-2 focus:ring-cyan-400 focus:border-cyan-400 focus:outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Text Color</label>
                    <div id="color-palette" class="flex flex-wrap gap-3"></div>
                </div>
            </div>
        </div>
        <div class="bg-black/50 px-6 py-4 flex justify-end gap-3 rounded-b-2xl">
            <button id="cancel-edit" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600 font-semibold transition">Cancel</button>
            <button id="save-edit" class="px-4 py-2 rounded-lg bg-cyan-500 hover:bg-cyan-400 text-black font-semibold transition">Save Changes</button>
        </div>
    </div>
</div>

<script>
    // Your Firebase Configuration is now included
    const firebaseConfig = {
        apiKey: "AIzaSyDrWCHmSHWYwWNjDYYqbV1lASEiJbXeT8U",
        authDomain: "personal-dashboard-e8c8f.firebaseapp.com",
        projectId: "personal-dashboard-e8c8f",
        storageBucket: "personal-dashboard-e8c8f.firebasestorage.app",
        messagingSenderId: "906260519522",
        appId: "1:906260519522:web:f7d2e9666e3ee20d260f3b",
        measurementId: "G-R2Z1CJ9TW6"
    };

    // --- Initialize Firebase ---
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- App ---
    document.addEventListener('DOMContentLoaded', () => {
        const loadingOverlay = document.getElementById('loading-overlay');
        const taskForm = document.getElementById('task-form');
        const taskTextInput = document.getElementById('task-text');
        const taskDateInput = document.getElementById('task-date');
        const taskTimeInput = document.getElementById('task-time');
        const taskListContainer = document.getElementById('task-list-container');

        const editModal = document.getElementById('edit-modal');
        const editTextInput = document.getElementById('edit-text');
        const editDateInput = document.getElementById('edit-date');
        const editTimeInput = document.getElementById('edit-time');
        const colorPaletteContainer = document.getElementById('color-palette');
        const saveEditBtn = document.getElementById('save-edit');
        const cancelEditBtn = document.getElementById('cancel-edit');

        let currentlyEditingId = null;
        const colors = ['#ffffff', '#08d9d6', '#ff2e63', '#f8b400', '#76ff03', '#9d00ff', '#ffff00'];
        const DEFAULT_COLOR = colors[0];

        let tasksCollection;
        let unsubscribe;

        // --- Authentication ---
        auth.onAuthStateChanged(user => {
            if (user) {
                setupAppForUser(user);
            } else {
                auth.signInAnonymously().catch(error => {
                    console.error("Error signing in anonymously:", error);
                    alert("Could not connect. Please check Firebase setup.");
                });
            }
        });

        function setupAppForUser(user) {
            tasksCollection = db.collection('users').doc(user.uid).collection('tasks');
            loadingOverlay.classList.add('opacity-0', 'pointer-events-none');

            const now = new Date();
            taskDateInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
            taskTimeInput.value = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            if (unsubscribe) unsubscribe(); // Detach any old listener
            unsubscribe = tasksCollection.orderBy("datetime", "asc").onSnapshot(snapshot => {
                const tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTasks(tasks);
            }, error => console.error("Error listening to tasks:", error));
        }

        // --- Rendering ---
        const renderTasks = (tasks) => {
            taskListContainer.innerHTML = '';
            if (tasks.length === 0) {
                taskListContainer.innerHTML = `<div class="text-center py-12 bg-black/30 backdrop-blur-lg border border-dashed border-cyan-500/20 rounded-xl"><svg class="mx-auto h-12 w-12 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><h3 class="mt-2 text-lg font-medium text-slate-300">All Tasks Completed</h3><p class="mt-1 text-sm text-slate-500">Add a new task to begin.</p></div>`;
                return;
            }

            tasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = `task-item bg-black/50 backdrop-blur-lg border border-slate-700/50 rounded-xl p-4 flex items-start gap-4 transition-all duration-300 ${task.completed ? 'opacity-40' : ''}`;
                taskElement.dataset.id = task.id;
                if (!task.completed) taskElement.style.borderLeft = `4px solid ${task.color || DEFAULT_COLOR}`;

                const taskDate = new Date(task.datetime);
                const formattedDate = new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long', day: 'numeric' }).format(taskDate);
                const formattedTime = new Intl.DateTimeFormat('en-US', { hour: '2-digit', minute: '2-digit', hour12: true }).format(taskDate);
                const taskTextColor = task.completed ? '#64748b' : (task.color || DEFAULT_COLOR);

                taskElement.innerHTML = `
                        <input type="checkbox" ${task.completed ? 'checked' : ''} class="task-checkbox h-6 w-6 mt-1 bg-transparent border-slate-600 rounded-md text-cyan-400 focus:ring-cyan-400 cursor-pointer">
                        <div class="flex-grow">
                            <p class="font-medium text-lg ${task.completed ? 'line-through' : ''}" style="color: ${taskTextColor};">${task.text}</p>
                            <p class="text-sm text-cyan-400/80">${formattedDate} at ${formattedTime}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="edit-task p-2 rounded-full hover:bg-cyan-500/20 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 hover:text-cyan-400"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg></button>
                            <button class="delete-task p-2 rounded-full hover:bg-pink-500/20 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500 hover:text-pink-500"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
                        </div>`;
                taskListContainer.appendChild(taskElement);
                setTimeout(() => taskElement.classList.add('item-enter-animate'), 10);
            });
        };

        // --- Firestore Actions ---
        const addTask = (text, date, time) => {
            if (!text || !date || !time) return alert('Please complete all fields.');
            tasksCollection.add({
                text: text,
                datetime: `${date}T${time}`,
                completed: false,
                color: DEFAULT_COLOR,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(err => console.error("Error adding task: ", err));
        };

        const toggleTask = (id) => {
            const taskRef = tasksCollection.doc(id);
            taskRef.get().then(doc => {
                if (doc.exists) taskRef.update({ completed: !doc.data().completed });
            }).catch(err => console.error("Error toggling task: ", err));
        };

        const deleteTask = (id) => tasksCollection.doc(id).delete();

        const handleEditSave = () => {
            const newText = editTextInput.value;
            const newDate = editDateInput.value;
            const newTime = editTimeInput.value;
            const selectedSwatch = document.querySelector('.color-swatch.ring-2');
            const selectedColor = selectedSwatch ? selectedSwatch.dataset.color : DEFAULT_COLOR;

            if (!newText || !newDate || !newTime) return alert('Please ensure all fields are complete.');

            tasksCollection.doc(currentlyEditingId).update({
                text: newText,
                datetime: `${newDate}T${newTime}`,
                color: selectedColor
            }).then(() => closeEditModal())
                .catch(err => console.error("Error updating task: ", err));
        };

        // --- Modal and Palette Logic ---
        const openEditModal = (id) => {
            const taskRef = tasksCollection.doc(id);
            taskRef.get().then(doc => {
                if (doc.exists) {
                    const task = doc.data();
                    currentlyEditingId = id;
                    editTextInput.value = task.text;
                    const [date, time] = task.datetime.split('T');
                    editDateInput.value = date;
                    editTimeInput.value = time.substring(0, 5);

                    renderColorPalette(task.color || DEFAULT_COLOR);
                    editModal.classList.remove('hidden');
                } else {
                    console.log("No such document!");
                }
            }).catch(error => console.log("Error getting document:", error));
        };

        const closeEditModal = () => {
            currentlyEditingId = null;
            editModal.classList.add('hidden');
        };

        const renderColorPalette = (activeColor) => {
            colorPaletteContainer.innerHTML = '';
            colors.forEach(color => {
                const swatch = document.createElement('button');
                swatch.type = 'button';
                swatch.className = `color-swatch w-8 h-8 rounded-full transition-all duration-200 border-2 border-transparent`;
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;
                if (color === activeColor) swatch.classList.add('ring-2', 'ring-offset-2', 'ring-cyan-400', 'ring-offset-gray-900');
                colorPaletteContainer.appendChild(swatch);
            });
        };

        // --- Event Listeners ---
        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addTask(taskTextInput.value, taskDateInput.value, taskTimeInput.value);
            taskTextInput.value = '';
            taskTextInput.focus();
        });

        taskListContainer.addEventListener('click', (e) => {
            const taskElement = e.target.closest('.task-item');
            if (!taskElement) return;

            const taskId = taskElement.dataset.id;
            if (e.target.closest('.task-checkbox')) toggleTask(taskId);
            if (e.target.closest('.delete-task')) deleteTask(taskId);
            if (e.target.closest('.edit-task')) openEditModal(taskId);
        });

        colorPaletteContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('color-swatch')) {
                document.querySelector('.color-swatch.ring-2')?.classList.remove('ring-2', 'ring-offset-2', 'ring-cyan-400', 'ring-offset-gray-900');
                e.target.classList.add('ring-2', 'ring-offset-2', 'ring-cyan-400', 'ring-offset-gray-900');
            }
        });

        saveEditBtn.addEventListener('click', handleEditSave);
        cancelEditBtn.addEventListener('click', closeEditModal);
        editModal.addEventListener('click', (e) => { if (e.target === editModal) closeEditModal(); });

    });
</script>
</body>
</html>