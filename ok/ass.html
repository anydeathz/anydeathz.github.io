<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Code Display</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .code-container {
            background-color: #2d2d2d; /* Dark background for code */
            color: #f8f8f2; /* Light text color */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            overflow-x: auto; /* Enable horizontal scrolling for long lines */
            width: 100%;
            max-width: 900px;
        }
        pre {
            margin: 0;
            white-space: pre-wrap; /* Wrap long lines */
            word-wrap: break-word; /* Break words if necessary */
        }
        code {
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace; /* Monospace font for code */
            font-size: 0.9rem;
            line-height: 1.4;
        }
        /* Basic syntax highlighting (can be expanded with a library like highlight.js) */
        .keyword { color: #cc7832; } /* e.g., import, from */
        .function { color: #ffc66d; } /* e.g., print, pd.read_csv */
        .string { color: #6a8759; } /* e.g., "whitegrid" */
        .comment { color: #808080; } /* e.g., # Set plot style */
        .variable { color: #9876aa; } /* e.g., df, plt */
        .number { color: #6897bb; } /* e.g., 10, 6 */
        .operator { color: #f8f8f2; } /* e.g., =, +, - */
        .class { color: #da4939; } /* e.g., pandas.core.frame.DataFrame */
        .type { color: #629755; } /* e.g., int64, float64, object */
    </style>
</head>
<body>
    <div class="code-container">
        <h2 class="text-xl font-bold mb-4 text-gray-100">Python Code</h2>
        <pre><code>
<span class="keyword">import</span> <span class="variable">pandas</span> <span class="keyword">as</span> <span class="variable">pd</span>
<span class="keyword">import</span> <span class="variable">numpy</span> <span class="keyword">as</span> <span class="variable">np</span>
<span class="keyword">import</span> <span class="variable">matplotlib.pyplot</span> <span class="keyword">as</span> <span class="variable">plt</span>
<span class="keyword">import</span> <span class="variable">seaborn</span> <span class="keyword">as</span> <span class="variable">sns</span>
<span class="keyword">from</span> <span class="variable">sklearn.preprocessing</span> <span class="keyword">import</span> <span class="variable">StandardScaler</span>
<span class="keyword">from</span> <span class="variable">sklearn.cluster</span> <span class="keyword">import</span> <span class="variable">KMeans</span>
<span class="keyword">from</span> <span class="variable">sklearn.metrics</span> <span class="keyword">import</span> <span class="variable">silhouette_score</span>, <span class="variable">davies_bouldin_score</span>
<span class="keyword">from</span> <span class="variable">sklearn.model_selection</span> <span class="keyword">import</span> <span class="variable">RandomizedSearchCV</span>
<span class="keyword">from</span> <span class="variable">scipy.stats</span> <span class="keyword">import</span> <span class="variable">randint</span>, <span class="variable">uniform</span>
<span class="keyword">import</span> <span class="variable">datetime</span> <span class="keyword">as</span> <span class="variable">dt</span>

<span class="comment"># Set plot style</span>
<span class="variable">sns</span>.<span class="function">set_style</span>(<span class="string">"whitegrid"</span>)
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'figure.figsize'</span>] <span class="operator">=</span> (<span class="number">10</span>, <span class="number">6</span>)
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'font.size'</span>] <span class="operator">=</span> <span class="number">12</span>
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'axes.labelsize'</span>] <span class="operator">=</span> <span class="number">14</span>
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'axes.titlesize'</span>] <span class="operator">=</span> <span class="number">16</span>
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'xtick.labelsize'</span>] <span class="operator">=</span> <span class="number">12</span>
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'ytick.labelsize'</span>] <span class="operator">=</span> <span class="number">12</span>
<span class="variable">plt</span>.<span class="variable">rcParams</span>[<span class="string">'legend.fontsize'</span>] <span class="operator">=</span> <span class="number">12</span>

<span class="variable">df</span> <span class="operator">=</span> <span class="variable">pd</span>.<span class="function">read_csv</span>(<span class="string">'transaction.csv'</span>, <span class="variable">encoding</span><span class="operator">=</span><span class="string">'utf-8'</span>)

<span class="comment"># 2. Data Understanding & Initial Cleaning</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="function">print</span>(<span class="string">"\n--- Initial Data Overview ---"</span>)
<span class="function">print</span>(<span class="variable">df</span>.<span class="function">head</span>())
<span class="function">print</span>(<span class="string">"\nData Info:"</span>)
<span class="variable">df</span>.<span class="function">info</span>()
<span class="function">print</span>(<span class="string">"\nMissing Values:"</span>)
<span class="function">print</span>(<span class="variable">df</span>.<span class="function">isnull</span>().<span class="function">sum</span>())
<span class="function">print</span>(<span class="string">"\nDescriptive Statistics:"</span>)
<span class="function">print</span>(<span class="variable">df</span>.<span class="function">describe</span>())

<span class="comment"># Handle missing CustomerIDs: Drop rows where CustomerID is null</span>
<span class="comment"># As customer segmentation is the goal, rows without a customer ID are not useful.</span>
<span class="variable">df</span>.<span class="function">dropna</span>(<span class="variable">inplace</span><span class="operator">=</span><span class="keyword">True</span>)

<span class="function">print</span>(<span class="string">f"\nShape after dropping rows with null CustomerID: {df.shape}"</span>)
<span class="function">print</span>(<span class="string">"\nMissing Values after CustomerID drop:"</span>)
<span class="function">print</span>(<span class="variable">df</span>.<span class="function">isnull</span>().<span class="function">sum</span>())

<span class="comment"># Convert 'Invoice Date' to datetime objects</span>
<span class="variable">df</span>[<span class="string">'InvoiceDate'</span>] <span class="operator">=</span> <span class="variable">pd</span>.<span class="function">to_datetime</span>(<span class="variable">df</span>[<span class="string">'InvoiceDate'</span>])
<span class="function">print</span>(<span class="string">"\n'InvoiceDate' data type after conversion:"</span>)
<span class="function">print</span>(<span class="variable">df</span>[<span class="string">'InvoiceDate'</span>].<span class="variable">dtype</span>)
<span class="comment"># 2. Plot BEFORE cleaning</span>
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">12</span>, <span class="number">5</span>))

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)
<span class="variable">plt</span>.<span class="function">scatter</span>(<span class="variable">df</span>.<span class="variable">index</span>, <span class="variable">df</span>[<span class="string">'Quantity'</span>])
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">"Quantity (Before)"</span>)
<span class="variable">plt</span>.<span class="function">xlabel</span>(<span class="string">"Index"</span>)
<span class="variable">plt</span>.<span class="function">ylabel</span>(<span class="string">"Quantity"</span>)

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)
<span class="variable">plt</span>.<span class="function">scatter</span>(<span class="variable">df</span>.<span class="variable">index</span>, <span class="variable">df</span>[<span class="string">'UnitPrice'</span>])
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">"UnitPrice (Before)"</span>)
<span class="variable">plt</span>.<span class="function">xlabel</span>(<span class="string">"Index"</span>)
<span class="variable">plt</span>.<span class="function">ylabel</span>(<span class="string">"UnitPrice"</span>)

<span class="variable">plt</span>.<span class="function">tight_layout</span>()
<span class="variable">plt</span>.<span class="function">show</span>()

<span class="comment"># 3. Store initial row count</span>
<span class="variable">before_rows</span> <span class="operator">=</span> <span class="variable">df</span>.<span class="variable">shape</span>[<span class="number">0</span>]
<span class="comment"># 4. Remove top 1% outliers from the same DataFrame</span>
<span class="variable">q_thresh</span> <span class="operator">=</span> <span class="variable">df</span>[<span class="string">'Quantity'</span>].<span class="function">quantile</span>(<span class="number">0.99</span>)
<span class="variable">p_thresh</span> <span class="operator">=</span> <span class="variable">df</span>[<span class="string">'UnitPrice'</span>].<span class="function">quantile</span>(<span class="number">0.99</span>)
<span class="variable">df</span> <span class="operator">=</span> <span class="variable">df</span>[(<span class="variable">df</span>[<span class="string">'Quantity'</span>] <span class="operator"><=</span> <span class="variable">q_thresh</span>) <span class="operator">&</span> (<span class="variable">df</span>[<span class="string">'UnitPrice'</span>] <span class="operator"><=</span> <span class="variable">p_thresh</span>)]
<span class="comment"># 5. Plot AFTER cleaning</span>
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">12</span>, <span class="number">5</span>))

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">1</span>)
<span class="variable">plt</span>.<span class="function">scatter</span>(<span class="variable">df</span>.<span class="variable">index</span>, <span class="variable">df</span>[<span class="string">'Quantity'</span>])
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">"Quantity (After)"</span>)
<span class="variable">plt</span>.<span class="function">xlabel</span>(<span class="string">"Index"</span>)
<span class="variable">plt</span>.<span class="function">ylabel</span>(<span class="string">"Quantity"</span>)

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>)
<span class="variable">plt</span>.<span class="function">scatter</span>(<span class="variable">df</span>.<span class="variable">index</span>, <span class="variable">df</span>[<span class="string">'UnitPrice'</span>])
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">"UnitPrice (After)"</span>)
<span class="variable">plt</span>.<span class="function">xlabel</span>(<span class="string">"Index"</span>)
<span class="variable">plt</span>.<span class="function">ylabel</span>(<span class="string">"UnitPrice"</span>)

<span class="variable">plt</span>.<span class="function">tight_layout</span>()
<span class="variable">plt</span>.<span class="function">show</span>()

<span class="comment"># 6. Summary of row counts</span>
<span class="variable">after_rows</span> <span class="operator">=</span> <span class="variable">df</span>.<span class="variable">shape</span>[<span class="number">0</span>]

<span class="function">print</span>(<span class="string">f"Rows before cleaning: {before_rows}"</span>)
<span class="function">print</span>(<span class="string">f"Rows after cleaning: {after_rows}"</span>)
<span class="function">print</span>(<span class="string">f"Rows removed: {before_rows - after_rows}"</span>)
<span class="comment"># 3. Feature Engineering & Data Preparation (RFM Analysis)</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="comment"># Calculate TotalPrice for each transaction line</span>
<span class="variable">df</span>[<span class="string">'TotalPrice'</span>] <span class="operator">=</span> <span class="variable">df</span>[<span class="string">'Quantity'</span>] <span class="operator">*</span> <span class="variable">df</span>[<span class="string">'UnitPrice'</span>]
<span class="comment"># Step 1: Convert StockCode to string</span>
<span class="variable">df</span>[<span class="string">'StockCode'</span>] <span class="operator">=</span> <span class="variable">df</span>[<span class="string">'StockCode'</span>].<span class="function">astype</span>(<span class="keyword">str</span>)

<span class="comment"># Step 2: Keep only rows with StockCodes that are 5, 6, or 7 characters long</span>
<span class="variable">df</span> <span class="operator">=</span> <span class="variable">df</span>[<span class="variable">df</span>[<span class="string">'StockCode'</span>].<span class="variable">str</span>.<span class="function">len</span>().<span class="function">isin</span>([<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>])]

<span class="function">print</span>(<span class="string">f"\nShape after filtering by StockCode length: {df.shape}"</span>)
<span class="variable">df_filtered</span> <span class="operator">=</span> <span class="variable">df</span>.<span class="function">copy</span>()
<span class="comment"># Convert Quantity and UnitPrice to numeric (coerce errors to NaN)</span>
<span class="variable">df_filtered</span>[<span class="string">'Quantity'</span>] <span class="operator">=</span> <span class="variable">pd</span>.<span class="function">to_numeric</span>(<span class="variable">df_filtered</span>[<span class="string">'Quantity'</span>], <span class="variable">errors</span><span class="operator">=</span><span class="string">'coerce'</span>)
<span class="variable">df_filtered</span>[<span class="string">'UnitPrice'</span>] <span class="operator">=</span> <span class="variable">pd</span>.<span class="function">to_numeric</span>(<span class="variable">df_filtered</span>[<span class="string">'UnitPrice'</span>], <span class="variable">errors</span><span class="operator">=</span><span class="string">'coerce'</span>)

<span class="comment"># Drop rows where conversion failed (i.e., NaNs)</span>
<span class="variable">df_filtered</span> <span class="operator">=</span> <span class="variable">df_filtered</span>.<span class="function">dropna</span>(<span class="variable">subset</span><span class="operator">=</span>[<span class="string">'Quantity'</span>, <span class="string">'UnitPrice'</span>])

<span class="comment"># Filter positive quantities and unit prices</span>
<span class="variable">df_filtered</span> <span class="operator">=</span> <span class="variable">df_filtered</span>[<span class="variable">df_filtered</span>[<span class="string">'Quantity'</span>] <span class="operator">></span> <span class="number">0</span>]
<span class="variable">df_filtered</span> <span class="operator">=</span> <span class="variable">df_filtered</span>[<span class="variable">df_filtered</span>[<span class="string">'UnitPrice'</span>] <span class="operator">></span> <span class="number">0</span>]

<span class="function">print</span>(<span class="string">f"\nShape after cleaning: {df_filtered.shape}"</span>)
<span class="comment"># Aggregate duplicate items within the same invoice (as per PDF Page 10)</span>
<span class="comment"># This step ensures that if a customer buys the same item multiple times in one transaction,</span>
<span class="comment"># the quantity is summed up, preventing overcounting for frequency.</span>
<span class="variable">df_processed</span> <span class="operator">=</span> <span class="variable">df_filtered</span>.<span class="function">groupby</span>([<span class="string">'InvoiceNo'</span>, <span class="string">'StockCode'</span>, <span class="string">'Description'</span>, <span class="string">'InvoiceDate'</span>, <span class="string">'CustomerID'</span>, <span class="string">'UnitPrice'</span>])[<span class="string">'Quantity'</span>].<span class="function">sum</span>().<span class="function">reset_index</span>()
<span class="variable">df_processed</span>[<span class="string">'TotalPrice'</span>] <span class="operator">=</span> <span class="variable">df_processed</span>[<span class="string">'Quantity'</span>] <span class="operator">*</span> <span class="variable">df_processed</span>[<span class="string">'UnitPrice'</span>]

<span class="function">print</span>(<span class="string">f"\nShape after aggregating duplicate items within invoices: {df_processed.shape}"</span>)
<span class="function">print</span>(<span class="string">"\nSample of processed data:"</span>)
<span class="function">print</span>(<span class="variable">df_processed</span>.<span class="function">head</span>())
<span class="comment"># RFM Analysis</span>
<span class="comment"># Recency: Days since last purchase</span>
<span class="comment"># Frequency: Number of unique transactions</span>
<span class="comment"># Monetary: Total spending</span>

<span class="comment"># Define a snapshot date for Recency calculation (e.g., one day after the last transaction in the dataset)</span>
<span class="variable">snapshot_date</span> <span class="operator">=</span> <span class="variable">df_processed</span>[<span class="string">'InvoiceDate'</span>].<span class="function">max</span>() <span class="operator">+</span> <span class="variable">dt</span>.<span class="variable">timedelta</span>(<span class="variable">days</span><span class="operator">=</span><span class="number">1</span>)
<span class="function">print</span>(<span class="string">f"\nSnapshot Date for Recency Calculation: {snapshot_date}"</span>)

<span class="variable">rfm_df</span> <span class="operator">=</span> <span class="variable">df_processed</span>.<span class="function">groupby</span>(<span class="string">'CustomerID'</span>).<span class="function">agg</span>(
    <span class="variable">Recency</span><span class="operator">=</span>(<span class="string">'InvoiceDate'</span>, <span class="keyword">lambda</span> <span class="variable">date</span>: (<span class="variable">snapshot_date</span> <span class="operator">-</span> <span class="variable">date</span>.<span class="function">max</span>()).<span class="variable">days</span>),
    <span class="variable">Frequency</span><span class="operator">=</span>(<span class="string">'InvoiceNo'</span>, <span class="string">'nunique'</span>),
    <span class="variable">Monetary</span><span class="operator">=</span>(<span class="string">'TotalPrice'</span>, <span class="string">'sum'</span>)
).<span class="function">reset_index</span>()

<span class="function">print</span>(<span class="string">"\nRFM DataFrame Head:"</span>)
<span class="function">print</span>(<span class="variable">rfm_df</span>.<span class="function">head</span>())
<span class="function">print</span>(<span class="string">"\nRFM DataFrame Description:"</span>)
<span class="function">print</span>(<span class="variable">rfm_df</span>.<span class="function">describe</span>())
<span class="comment"># --- New EDA: Time-Series Analysis and Overall RFM Averages ---</span>
<span class="function">print</span>(<span class="string">"\n--- Exploratory Data Analysis: Time-Series Trends & Overall RFM ---"</span>)

<span class="comment"># Prepare data for time-series plots</span>
<span class="comment"># Aggregate by month for trends</span>
<span class="variable">df_monthly</span> <span class="operator">=</span> <span class="variable">df_processed</span>.<span class="function">set_index</span>(<span class="string">'InvoiceDate'</span>).<span class="function">resample</span>(<span class="string">'M'</span>).<span class="function">agg</span>(
    <span class="variable">TotalSales</span><span class="operator">=</span>(<span class="string">'TotalPrice'</span>, <span class="string">'sum'</span>),
    <span class="variable">TotalUnits</span><span class="operator">=</span>(<span class="string">'Quantity'</span>, <span class="string">'sum'</span>),
    <span class="variable">UniqueInvoices</span><span class="operator">=</span>(<span class="string">'InvoiceNo'</span>, <span class="string">'nunique'</span>),
    <span class="variable">UniqueCustomers</span><span class="operator">=</span>(<span class="string">'CustomerID'</span>, <span class="string">'nunique'</span>)
).<span class="function">reset_index</span>()

<span class="comment"># Calculate average sale per invoice</span>
<span class="variable">df_monthly</span>[<span class="string">'AverageSalePerInvoice'</span>] <span class="operator">=</span> <span class="variable">df_monthly</span>[<span class="string">'TotalSales'</span>] <span class="operator">/</span> <span class="variable">df_monthly</span>[<span class="string">'UniqueInvoices'</span>]

<span class="comment"># Plotting time-series trends</span>
<span class="variable">fig</span>, <span class="variable">axes</span> <span class="operator">=</span> <span class="variable">plt</span>.<span class="function">subplots</span>(<span class="variable">nrows</span><span class="operator">=</span><span class="number">4</span>, <span class="variable">ncols</span><span class="operator">=</span><span class="number">1</span>, <span class="variable">figsize</span><span class="operator">=</span>(<span class="number">12</span>, <span class="number">20</span>))
<span class="variable">fig</span>.<span class="function">suptitle</span>(<span class="string">'Monthly Trends Over Time'</span>, <span class="variable">y</span><span class="operator">=</span><span class="number">1.02</span>, <span class="variable">fontsize</span><span class="operator">=</span><span class="number">18</span>)

<span class="comment"># Monthly Total Sales</span>
<span class="variable">sns</span>.<span class="function">lineplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'InvoiceDate'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'TotalSales'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">df_monthly</span>, <span class="variable">ax</span><span class="operator">=</span><span class="variable">axes</span>[<span class="number">0</span>])
<span class="variable">axes</span>[<span class="number">0</span>].<span class="function">set_title</span>(<span class="string">'Monthly Total Sales'</span>)
<span class="variable">axes</span>[<span class="number">0</span>].<span class="function">set_ylabel</span>(<span class="string">'Total Sales (Currency Unit)'</span>)
<span class="variable">axes</span>[<span class="number">0</span>].<span class="function">set_xlabel</span>(<span class="string">'Date'</span>)

<span class="comment"># Monthly Total Units Sold</span>
<span class="variable">sns</span>.<span class="function">lineplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'InvoiceDate'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'TotalUnits'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">df_monthly</span>, <span class="variable">ax</span><span class="operator">=</span><span class="variable">axes</span>[<span class="number">1</span>])
<span class="variable">axes</span>[<span class="number">1</span>].<span class="function">set_title</span>(<span class="string">'Monthly Total Units Sold'</span>)
<span class="variable">axes</span>[<span class="number">1</span>].<span class="function">set_ylabel</span>(<span class="string">'Total Units'</span>)
<span class="variable">axes</span>[<span class="number">1</span>].<span class="function">set_xlabel</span>(<span class="string">'Date'</span>)

<span class="comment"># Monthly Average Sale Per Invoice</span>
<span class="variable">sns</span>.<span class="function">lineplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'InvoiceDate'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'AverageSalePerInvoice'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">df_monthly</span>, <span class="variable">ax</span><span class="operator">=</span><span class="variable">axes</span>[<span class="number">2</span>])
<span class="variable">axes</span>[<span class="number">2</span>].<span class="function">set_title</span>(<span class="string">'Monthly Average Sale Per Invoice'</span>)
<span class="variable">axes</span>[<span class="number">2</span>].<span class="function">set_ylabel</span>(<span class="string">'Average Sale (Currency Unit)'</span>)
<span class="variable">axes</span>[<span class="number">2</span>].<span class="function">set_xlabel</span>(<span class="string">'Date'</span>)

<span class="comment"># Monthly Unique Customers</span>
<span class="variable">sns</span>.<span class="function">lineplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'InvoiceDate'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'UniqueCustomers'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">df_monthly</span>, <span class="variable">ax</span><span class="operator">=</span><span class="variable">axes</span>[<span class="number">3</span>])
<span class="variable">axes</span>[<span class="number">3</span>].<span class="function">set_title</span>(<span class="string">'Monthly Unique Customers'</span>)
<span class="variable">axes</span>[<span class="number">3</span>].<span class="function">set_ylabel</span>(<span class="string">'Number of Unique Customers'</span>)
<span class="variable">axes</span>[<span class="number">3</span>].<span class="function">set_xlabel</span>(<span class="string">'Date'</span>)

<span class="variable">plt</span>.<span class="function">tight_layout</span>(<span class="variable">rect</span><span class="operator">=</span>[<span class="number">0</span>, <span class="number">0.03</span>, <span class="number">1</span>, <span class="number">0.98</span>])
<span class="variable">plt</span>.<span class="function">show</span>()

<span class="comment"># Overall Average RFM Values (Bar Plot)</span>
<span class="variable">overall_avg_rfm</span> <span class="operator">=</span> <span class="variable">rfm_df</span>[[<span class="string">'Recency'</span>, <span class="string">'Frequency'</span>, <span class="string">'Monetary'</span>]].<span class="function">mean</span>()
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">8</span>, <span class="number">6</span>))
<span class="variable">sns</span>.<span class="function">barplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="variable">overall_avg_rfm</span>.<span class="variable">index</span>, <span class="variable">y</span><span class="operator">=</span><span class="variable">overall_avg_rfm</span>.<span class="variable">values</span>, <span class="variable">palette</span><span class="operator">=</span><span class="string">'viridis'</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Overall Average RFM Values'</span>)
<span class="variable">plt</span>.<span class="function">ylabel</span>(<span class="string">'Average Value'</span>)
<span class="variable">plt</span>.<span class="function">show</span>()
<span class="comment"># Handle Outliers (Optional but Recommended for RFM)</span>
<span class="comment"># Visualize distributions to identify outliers</span>
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">15</span>, <span class="number">5</span>))
<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>)
<span class="variable">sns</span>.<span class="function">histplot</span>(<span class="variable">rfm_df</span>[<span class="string">'Recency'</span>], <span class="variable">bins</span><span class="operator">=</span><span class="number">50</span>, <span class="variable">kde</span><span class="operator">=</span><span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Recency Distribution'</span>)
<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>)
<span class="variable">sns</span>.<span class="function">histplot</span>(<span class="variable">rfm_df</span>[<span class="string">'Frequency'</span>], <span class="variable">bins</span><span class="operator">=</span><span class="number">50</span>, <span class="variable">kde</span><span class="operator">=</span><span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Frequency Distribution'</span>)
<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)
<span class="variable">sns</span>.<span class="function">histplot</span>(<span class="variable">rfm_df</span>[<span class="string">'Monetary'</span>], <span class="variable">bins</span><span class="operator">=</span><span class="number">50</span>, <span class="variable">kde</span><span class="operator">=</span><span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Monetary Distribution'</span>)
<span class="variable">plt</span>.<span class="function">tight_layout</span>()
<span class="variable">plt</span>.<span class="function">show</span>()



<span class="comment"># Apply log transformation to Recency, Frequency and Monetary due to skewed distributions</span>
<span class="comment"># Add a small constant to avoid log(0) if there are zero values.</span>
<span class="comment"># Recency can be 0 for customers who purchased on the snapshot date, so log1p is good.</span>
<span class="variable">rfm_df</span>[<span class="string">'Recency_log'</span>] <span class="operator">=</span> <span class="variable">np</span>.<span class="function">log1p</span>(<span class="variable">rfm_df</span>[<span class="string">'Recency'</span>])
<span class="variable">rfm_df</span>[<span class="string">'Frequency_log'</span>] <span class="operator">=</span> <span class="variable">np</span>.<span class="function">log1p</span>(<span class="variable">rfm_df</span>[<span class="string">'Frequency'</span>])
<span class="variable">rfm_df</span>[<span class="string">'Monetary_log'</span>] <span class="operator">=</span> <span class="variable">np</span>.<span class="function">log1p</span>(<span class="variable">rfm_df</span>[<span class="string">'Monetary'</span>])

<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">15</span>, <span class="number">5</span>))
<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>)
<span class="variable">sns</span>.<span class="function">histplot</span>(<span class="variable">rfm_df</span>[<span class="string">'Recency_log'</span>], <span class="variable">bins</span><span class="operator">=</span><span class="number">50</span>, <span class="variable">kde</span><span class="operator">=</span><span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Log-Transformed Recency Distribution'</span>)
<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>)
<span class="variable">sns</span>.<span class="function">histplot</span>(<span class="variable">rfm_df</span>[<span class="string">'Frequency_log'</span>], <span class="variable">bins</span><span class="operator">=</span><span class="number">50</span>, <span class="variable">kde</span><span class="operator">=</span><span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Log-Transformed Frequency Distribution'</span>)
<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)
<span class="variable">sns</span>.<span class="function">histplot</span>(<span class="variable">rfm_df</span>[<span class="string">'Monetary_log'</span>], <span class="variable">bins</span><span class="operator">=</span><span class="number">50</span>, <span class="variable">kde</span><span class="operator">=</span><span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Log-Transformed Monetary Distribution'</span>)
<span class="variable">plt</span>.<span class="function">tight_layout</span>()
<span class="variable">plt</span>.<span class="function">show</span>()

<span class="comment"># Correlation Heatmap of Log-Transformed RFM Features</span>
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">8</span>, <span class="number">6</span>))
<span class="variable">sns</span>.<span class="function">heatmap</span>(<span class="variable">rfm_df</span>[[<span class="string">'Recency_log'</span>, <span class="string">'Frequency_log'</span>, <span class="string">'Monetary_log'</span>]].<span class="function">corr</span>(),
            <span class="variable">annot</span><span class="operator">=</span><span class="keyword">True</span>, <span class="variable">cmap</span><span class="operator">=</span><span class="string">'coolwarm'</span>, <span class="variable">fmt</span><span class="operator">=</span><span class="string">".2f"</span>, <span class="variable">linewidths</span><span class="operator">=</span><span class="number">.5</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Correlation Matrix of Log-Transformed RFM Features'</span>)
<span class="variable">plt</span>.<span class="function">show</span>()


<span class="comment"># Select features for clustering</span>
<span class="variable">X</span> <span class="operator">=</span> <span class="variable">rfm_df</span>[[<span class="string">'Recency_log'</span>, <span class="string">'Frequency_log'</span>, <span class="string">'Monetary_log'</span>]]
<span class="comment"># 4. Data Scaling</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="comment"># Initialize StandardScaler</span>
<span class="variable">scaler</span> <span class="operator">=</span> <span class="variable">StandardScaler</span>()

<span class="comment"># Fit and transform the data</span>
<span class="variable">X_scaled</span> <span class="operator">=</span> <span class="variable">scaler</span>.<span class="function">fit_transform</span>(<span class="variable">X</span>)
<span class="variable">X_scaled_df</span> <span class="operator">=</span> <span class="variable">pd</span>.<span class="function">DataFrame</span>(<span class="variable">X_scaled</span>, <span class="variable">columns</span><span class="operator">=</span><span class="variable">X</span>.<span class="variable">columns</span>)

<span class="comment"># IMPORTANT: Check for NaN or Inf values after scaling</span>
<span class="comment"># If any NaNs or Infs are present, it implies a fundamental issue with the data or scaling</span>
<span class="keyword">if</span> <span class="variable">X_scaled_df</span>.<span class="function">isnull</span>().<span class="function">sum</span>().<span class="function">sum</span>() <span class="operator">></span> <span class="number">0</span>:
    <span class="function">print</span>(<span class="string">"\nERROR: NaN values found in scaled data even after capping and log transform. This should not happen."</span>)
    <span class="function">print</span>(<span class="variable">X_scaled_df</span>.<span class="function">isnull</span>().<span class="function">sum</span>())
    <span class="keyword">exit</span>() <span class="comment"># Exit if critical issue persists</span>

<span class="keyword">if</span> <span class="variable">np</span>.<span class="function">isinf</span>(<span class="variable">X_scaled_df</span>).<span class="function">sum</span>().<span class="function">sum</span>() <span class="operator">></span> <span class="number">0</span>:
    <span class="function">print</span>(<span class="string">"\nERROR: Inf values found in scaled data even after capping and log transform. This should not happen."</span>)
    <span class="function">print</span>(<span class="variable">np</span>.<span class="function">isinf</span>(<span class="variable">X_scaled_df</span>).<span class="function">sum</span>())
    <span class="keyword">exit</span>() <span class="comment"># Exit if critical issue persists</span>

<span class="comment"># If X_scaled_df becomes empty after cleaning, handle it gracefully</span>
<span class="keyword">if</span> <span class="variable">X_scaled_df</span>.<span class="function">empty</span>:
    <span class="function">print</span>(<span class="string">"\nERROR: Scaled DataFrame is empty after cleaning. Cannot proceed with clustering."</span>)
    <span class="keyword">exit</span>()

<span class="comment"># Ensure rfm_df_cleaned is always defined and aligned with X_scaled_df</span>
<span class="comment"># We'll use the indices of X_scaled_df to filter rfm_df</span>
<span class="variable">rfm_df_cleaned</span> <span class="operator">=</span> <span class="variable">rfm_df</span>.<span class="function">loc</span>[<span class="variable">X_scaled_df</span>.<span class="variable">index</span>].<span class="function">copy</span>()

<span class="function">print</span>(<span class="string">"\nScaled Data Head:"</span>)
<span class="function">print</span>(<span class="variable">X_scaled_df</span>.<span class="function">head</span>())
<span class="function">print</span>(<span class="string">"\nScaled Data Descriptive Statistics:"</span>)
<span class="function">print</span>(<span class="variable">X_scaled_df</span>.<span class="function">describe</span>())

<span class="comment"># 5. K-means Clustering: Determining Optimal K using Elbow Method</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="function">print</span>(<span class="string">"\n--- Determining Optimal K using Elbow Method ---"</span>)

<span class="comment"># Calculate inertia for a range of K values</span>
<span class="variable">inertia</span> <span class="operator">=</span> []
<span class="variable">k_range</span> <span class="operator">=</span> <span class="function">range</span>(<span class="number">2</span>, <span class="number">15</span>) <span class="comment"># Test K from 2 to 14</span>

<span class="keyword">for</span> <span class="variable">k</span> <span class="keyword">in</span> <span class="variable">k_range</span>:
    <span class="variable">kmeans_model</span> <span class="operator">=</span> <span class="variable">KMeans</span>(<span class="variable">n_clusters</span><span class="operator">=</span><span class="variable">k</span>, <span class="variable">random_state</span><span class="operator">=</span><span class="number">42</span>, <span class="variable">n_init</span><span class="operator">=</span><span class="number">10</span>)
    <span class="variable">kmeans_model</span>.<span class="function">fit</span>(<span class="variable">X_scaled_df</span>)
    <span class="variable">inertia</span>.<span class="function">append</span>(<span class="variable">kmeans_model</span>.<span class="variable">inertia_</span>)

<span class="comment"># Plot the Elbow Method graph</span>
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">10</span>, <span class="number">6</span>))
<span class="variable">plt</span>.<span class="function">plot</span>(<span class="variable">k_range</span>, <span class="variable">inertia</span>, <span class="variable">marker</span><span class="operator">=</span><span class="string">'o'</span>, <span class="variable">linestyle</span><span class="operator">=</span><span class="string">'--'</span>)
<span class="variable">plt</span>.<span class="function">xlabel</span>(<span class="string">'Number of Clusters (K)'</span>)
<span class="variable">plt</span>.<span class="function">ylabel</span>(<span class="string">'Inertia (Sum of Squared Distances)'</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Elbow Method for Optimal K'</span>)
<span class="variable">plt</span>.<span class="function">xticks</span>(<span class="variable">k_range</span>)
<span class="variable">plt</span>.<span class="function">grid</span>(<span class="keyword">True</span>)
<span class="variable">plt</span>.<span class="function">show</span>()

<span class="function">print</span>(<span class="string">"\nObserve the Elbow Method graph above to identify the optimal K."</span>)
<span class="function">print</span>(<span class="string">"The 'elbow' point is where the rate of decrease in inertia slows down significantly."</span>)
<span class="function">print</span>(<span class="string">"For example, if the elbow is at K=4, then 4 would be the optimal number of clusters."</span>)

<span class="variable">best_k</span> <span class="operator">=</span> <span class="number">4</span> <span class="comment"># <--- IMPORTANT: Replace this with the K you choose from the Elbow plot based on the plot you see</span>

<span class="function">print</span>(<span class="string">f"\nProceeding with K-Means clustering using best_k = {best_k} (chosen from Elbow Method)."</span>)

<span class="comment"># Fit K-means with the best K found (or chosen)</span>
<span class="variable">final_kmeans_model</span> <span class="operator">=</span> <span class="variable">KMeans</span>(<span class="variable">n_clusters</span><span class="operator">=</span><span class="variable">best_k</span>, <span class="variable">random_state</span><span class="operator">=</span><span class="number">42</span>, <span class="variable">n_init</span><span class="operator">=</span><span class="number">10</span>)
<span class="variable">final_kmeans_model</span>.<span class="function">fit</span>(<span class="variable">X_scaled_df</span>) <span class="comment"># Fit on the cleaned scaled data</span>

<span class="comment"># Assign cluster labels to the original RFM DataFrame (the cleaned one)</span>
<span class="variable">rfm_df_cleaned</span>[<span class="string">'Cluster'</span>] <span class="operator">=</span> <span class="variable">final_kmeans_model</span>.<span class="variable">labels_</span>

<span class="function">print</span>(<span class="string">"\nRFM DataFrame with Cluster Labels Head:"</span>)
<span class="function">print</span>(<span class="variable">rfm_df_cleaned</span>.<span class="function">head</span>())

<span class="comment"># 6. Cluster Analysis & Interpretation</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="function">print</span>(<span class="string">"\n--- Cluster Analysis ---"</span>)
<span class="variable">cluster_summary</span> <span class="operator">=</span> <span class="variable">rfm_df_cleaned</span>.<span class="function">groupby</span>(<span class="string">'Cluster'</span>)[[<span class="string">'Recency'</span>, <span class="string">'Frequency'</span>, <span class="string">'Monetary'</span>]].<span class="function">mean</span>().<span class="function">reset_index</span>()
<span class="function">print</span>(<span class="string">"\nMean RFM values per Cluster (Original Scale):"</span>)
<span class="function">print</span>(<span class="variable">cluster_summary</span>)

<span class="comment"># Visualize cluster characteristics (original scale for better interpretation)</span>
<span class="variable">plt</span>.<span class="function">figure</span>(<span class="variable">figsize</span><span class="operator">=</span>(<span class="number">18</span>, <span class="number">6</span>))

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">1</span>)
<span class="variable">sns</span>.<span class="function">boxplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'Cluster'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'Recency'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">rfm_df_cleaned</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Recency by Cluster'</span>)

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>)
<span class="variable">sns</span>.<span class="function">boxplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'Cluster'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'Frequency'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">rfm_df_cleaned</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Frequency by Cluster'</span>)

<span class="variable">plt</span>.<span class="function">subplot</span>(<span class="number">1</span>, <span class="number">3</span>, <span class="number">3</span>)
<span class="variable">sns</span>.<span class="function">boxplot</span>(<span class="variable">x</span><span class="operator">=</span><span class="string">'Cluster'</span>, <span class="variable">y</span><span class="operator">=</span><span class="string">'Monetary'</span>, <span class="variable">data</span><span class="operator">=</span><span class="variable">rfm_df_cleaned</span>)
<span class="variable">plt</span>.<span class="function">title</span>(<span class="string">'Monetary by Cluster'</span>)

<span class="variable">plt</span>.<span class="function">tight_layout</span>()
<span class="variable">plt</span>.<span class="function">show</span>()
<span class="comment"># Further interpretation of clusters</span>
<span class="comment"># Based on the box plots and cluster_summary, describe each cluster.</span>
<span class="comment"># Example interpretation (will vary based on actual data results):</span>
<span class="function">print</span>(<span class="string">"\n--- Cluster Interpretation ---"</span>)
<span class="comment"># Ensure that the median calculation is based on the rfm_df_cleaned</span>
<span class="variable">recency_median</span> <span class="operator">=</span> <span class="variable">rfm_df_cleaned</span>[<span class="string">'Recency'</span>].<span class="function">median</span>()
<span class="variable">frequency_median</span> <span class="operator">=</span> <span class="variable">rfm_df_cleaned</span>[<span class="string">'Frequency'</span>].<span class="function">median</span>()
<span class="variable">monetary_median</span> <span class="operator">=</span> <span class="variable">rfm_df_cleaned</span>[<span class="string">'Monetary'</span>].<span class="function">median</span>()

<span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="function">range</span>(<span class="variable">best_k</span>):
    <span class="function">print</span>(<span class="string">f"\nCluster {i}:"</span>)
    <span class="variable">cluster_recency</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Recency'</span>].<span class="variable">values</span>[<span class="number">0</span>]
    <span class="variable">cluster_frequency</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Frequency'</span>].<span class="variable">values</span>[<span class="number">0</span>]
    <span class="variable">cluster_monetary</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Monetary'</span>].<span class="variable">values</span>[<span class="number">0</span>]

    <span class="function">print</span>(<span class="string">f"  Average Recency: {cluster_recency:.2f} days"</span>)
    <span class="function">print</span>(<span class="string">f"  Average Frequency: {cluster_frequency:.2f} transactions"</span>)
    <span class="function">print</span>(<span class="string">f"  Average Monetary: {cluster_monetary:.2f} (currency unit)"</span>)

    <span class="comment"># Provide a descriptive name for the cluster based on its RFM values</span>
    <span class="keyword">if</span> <span class="variable">cluster_recency</span> <span class="operator"><</span> <span class="variable">recency_median</span> <span class="operator">and</span> \
       <span class="variable">cluster_frequency</span> <span class="operator">></span> <span class="variable">frequency_median</span> <span class="operator">and</span> \
       <span class="variable">cluster_monetary</span> <span class="operator">></span> <span class="variable">monetary_median</span>:
        <span class="function">print</span>(<span class="string">f"  Description: High-Value Loyal Customers (Recently purchased, frequent, high spending)"</span>)
    <span class="keyword">elif</span> <span class="variable">cluster_recency</span> <span class="operator">></span> <span class="variable">recency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_frequency</span> <span class="operator"><</span> <span class="variable">frequency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_monetary</span> <span class="operator"><</span> <span class="variable">monetary_median</span>:
        <span class="function">print</span>(<span class="string">f"  Description: At-Risk/Churning Customers (Not purchased recently, infrequent, low spending)"</span>)
    <span class="keyword">elif</span> <span class="variable">cluster_recency</span> <span class="operator"><</span> <span class="variable">recency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_frequency</span> <span class="operator"><</span> <span class="variable">frequency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_monetary</span> <span class="operator"><</span> <span class="variable">monetary_median</span>:
        <span class="function">print</span>(<span class="string">f"  Description: New/Low-Value Customers (Recently purchased, but infrequent and low spending)"</span>)
    <span class="keyword">else</span>:
        <span class="function">print</span>(<span class="string">f"  Description: (Further analysis needed to precisely define this cluster)"</span>)


<span class="comment"># 7. Reporting & Recommendations</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="function">print</span>(<span class="string">"\n--- Business Recommendations ---"</span>)
<span class="function">print</span>(<span class="string">"Based on the identified customer segments, here are some potential business strategies:"</span>)

<span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="function">range</span>(<span class="variable">best_k</span>):
    <span class="function">print</span>(<span class="string">f"\nFor Cluster {i}:"</span>)
    <span class="variable">cluster_recency</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Recency'</span>].<span class="variable">values</span>[<span class="number">0</span>]
    <span class="variable">cluster_frequency</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Frequency'</span>].<span class="variable">values</span>[<span class="number">0</span>]
    <span class="variable">cluster_monetary</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Monetary'</span>].<span class="variable">values</span>[<span class="number">0</span>]

    <span class="keyword">if</span> <span class="variable">cluster_recency</span> <span class="operator"><</span> <span class="variable">recency_median</span> <span class="operator">and</span> \
       <span class="variable">cluster_frequency</span> <span class="operator">></span> <span class="variable">frequency_median</span> <span class="operator">and</span> \
       <span class="variable">cluster_monetary</span> <span class="operator">></span> <span class="variable">monetary_median</span>:
        <span class="function">print</span>(<span class="string">"  Strategy: Retain and Reward. Offer exclusive loyalty programs, early access to new products, or personalized high-value recommendations to maintain their engagement."</span>)
    <span class="keyword">elif</span> <span class="variable">cluster_recency</span> <span class="operator">></span> <span class="variable">recency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_frequency</span> <span class="operator"><</span> <span class="variable">frequency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_monetary</span> <span class="operator"><</span> <span class="variable">monetary_median</span>:
        <span class="function">print</span>(<span class="string">"  Strategy: Re-engagement Campaigns. Send targeted promotions, win-back offers, or surveys to understand reasons for inactivity and encourage return purchases."</span>)
    <span class="keyword">elif</span> <span class="variable">cluster_recency</span> <span class="operator"><</span> <span class="variable">recency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_frequency</span> <span class="operator"><</span> <span class="variable">frequency_median</span> <span class="operator">and</span> \
         <span class="variable">cluster_monetary</span> <span class="operator"><</span> <span class="variable">monetary_median</span>:
        <span class="function">print</span>(<span class="string">"  Strategy: Nurture and Upsell. Focus on increasing their purchase frequency and monetary value through introductory offers, product bundles, or educational content."</span>)
    <span class="keyword">else</span>:
        <span class="function">print</span>(<span class="string">"  Strategy: (Develop specific strategies based on the unique characteristics of this cluster from the analysis above.)"</span>)

<span class="comment"># 7. Reporting & Recommendations</span>
<span class="comment"># -----------------------------------------------------------------------------</span>

<span class="function">print</span>(<span class="string">"\n--- Business Recommendations ---"</span>)
<span class="function">print</span>(<span class="string">"Based on the identified customer segments, here are some potential business strategies:"</span>)

<span class="keyword">for</span> <span class="variable">i</span> <span class="keyword">in</span> <span class="function">range</span>(<span class="variable">best_k</span>):
    <span class="function">print</span>(<span class="string">f"\nFor Cluster {i}:"</span>)
    <span class="variable">cluster_recency</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Recency'</span>].<span class="variable">values</span>[<span class="number">0</span>]
    <span class="variable">cluster_frequency</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Frequency'</span>].<span class="variable">values</span>[<span class="number">0</span>]
    <span class="variable">cluster_monetary</span> <span class="operator">=</span> <span class="variable">cluster_summary</span>.<span class="function">loc</span>[<span class="variable">cluster_summary</span>[<span class="string">'Cluster'</span>] <span class="operator">==</span> <span class="variable">i</span>, <span class="string">'Monetary'</span>].<span class="variable">values</span>[<span class="number">0</span>]

    <span class="keyword">if</span> <span class="variable">cluster_recency</span> <span class="operator"><</span> <span class="variable">rfm_df</span>[<span class="string">'Recency'</span>].<span class="function">median</span>() <span class="operator">and</span> \
       <span class="variable">cluster_frequency</span> <span class="operator">></span> <span class="variable">rfm_df</span>[<span class="string">'Frequency'</span>].<span class="function">median</span>() <span class="operator">and</span> \
       <span class="variable">cluster_monetary</span> <span class="operator">></span> <span class="variable">rfm_df</span>[<span class="string">'Monetary'</span>].<span class="function">median</span>():
        <span class="function">print</span>(<span class="string">"  Strategy: Retain and Reward. Offer exclusive loyalty programs, early access to new products, or personalized high-value recommendations to maintain their engagement."</span>)
    <span class="keyword">elif</span> <span class="variable">cluster_recency</span> <span class="operator">></span> <span class="variable">rfm_df</span>[<span class="string">'Recency'</span>].<span class="function">median</span>() <span class="operator">and</span> \
         <span class="variable">cluster_frequency</span> <span class="operator"><</span> <span class="variable">rfm_df</span>[<span class="string">'Frequency'</span>].<span class="function">median</span>() <span class="operator">and</span> \
         <span class="variable">cluster_monetary</span> <span class="operator"><</span> <span class="variable">rfm_df</span>[<span class="string">'Monetary'</span>].<span class="function">median</span>():
        <span class="function">print</span>(<span class="string">"  Strategy: Re-engagement Campaigns. Send targeted promotions, win-back offers, or surveys to understand reasons for inactivity and encourage return purchases."</span>)
    <span class="keyword">elif</span> <span class="variable">cluster_recency</span> <span class="operator"><</span> <span class="variable">rfm_df</span>[<span class="string">'Recency'</span>].<span class="function">median</span>() <span class="operator">and</span> \
         <span class="variable">cluster_frequency</span> <span class="operator"><</span> <span class="variable">rfm_df</span>[<span class="string">'Frequency'</span>].<span class="function">median</span>() <span class="operator">and</span> \
         <span class="variable">cluster_monetary</span> <span class="operator"><</span> <span class="variable">rfm_df</span>[<span class="string">'Monetary'</span>].<span class="function">median</span>():
        <span class="function">print</span>(<span class="string">"  Strategy: Nurture and Upsell. Focus on increasing their purchase frequency and monetary value through introductory offers, product bundles, or educational content."</span>)
    <span class="keyword">else</span>:
        <span class="function">print</span>(<span class="string">"  Strategy: (Develop specific strategies based on the unique characteristics of this cluster from the analysis above.)"</span>)

<span class="comment"># Optional: Save the RFM DataFrame with cluster labels</span>
<span class="variable">rfm_df_cleaned</span>.<span class="function">to_csv</span>(<span class="string">'customer_rfm_clusters.csv'</span>, <span class="variable">index</span><span class="operator">=</span><span class="keyword">False</span>)
<span class="function">print</span>(<span class="string">"\n--- Analysis Complete ---"</span>)
        </code></pre>
    </div>
</body>
</html>